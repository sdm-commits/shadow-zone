<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadow Zone — Sequence + Platoon</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
 :root {
  --bg: #ffffff; --bg2: #f8f9fa; --bg3: #f1f3f5;
  --surface: #ffffff; --border: #e9ecef; --border2: #dee2e6;
  --text: #1a1a2e; --text2: #6c757d; --text3: #adb5bd;
  --accent: #c62828; --accent-bg: rgba(198,40,40,0.06);
  --green: #2e7d32; --green-bg: rgba(46,125,50,0.07);
  --red: #c62828; --red-bg: rgba(198,40,40,0.06);
  --blue: #1565c0; --blue-bg: rgba(21,101,192,0.06);
  --orange: #e65100; --orange-bg: rgba(230,81,0,0.06);
  --mono: 'JetBrains Mono', monospace;
  --sans: 'IBM Plex Sans', -apple-system, sans-serif;
 }
 * { margin:0; padding:0; box-sizing:border-box; }
 body { background:var(--bg); color:var(--text); font-family:var(--sans); min-height:100vh; -webkit-font-smoothing:antialiased; }

 .header { padding:24px 32px 20px; border-bottom:1px solid var(--border); }
 .header-row { display:flex; align-items:center; gap:12px; margin-bottom:4px; }
 .header h1 { font-size:20px; font-weight:700; letter-spacing:-0.4px; }
 .header .tag { font-family:var(--mono); font-size:10px; font-weight:600; letter-spacing:0.8px; background:var(--accent-bg); color:var(--accent); padding:3px 8px; border-radius:4px; }
 .header p { font-size:13px; color:var(--text2); margin-top:2px; }

 .content { padding:0 32px 40px; }

 .stats { display:flex; gap:1px; background:var(--border); border:1px solid var(--border); border-radius:8px; overflow:hidden; margin:20px 0 24px; }
 .stat { flex:1; background:var(--surface); padding:14px 16px; }
 .stat .label { font-family:var(--mono); font-size:9px; font-weight:600; letter-spacing:1.2px; color:var(--text3); text-transform:uppercase; margin-bottom:4px; }
 .stat .val { font-family:var(--mono); font-size:22px; font-weight:700; letter-spacing:-0.5px; }
 .stat .sub { font-size:11px; color:var(--text3); margin-top:1px; }

 .tabs { display:flex; gap:0; border-bottom:1px solid var(--border); margin-bottom:24px; overflow-x:auto; }
 .tab { padding:10px 20px; font-family:var(--sans); font-size:13px; font-weight:500; color:var(--text2); background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; transition:all 0.12s; white-space:nowrap; }
 .tab:hover { color:var(--text); }
 .tab.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:600; }

 .grid { display:grid; gap:16px; }
 .grid-2 { grid-template-columns:1fr 1fr; }
 .grid-3 { grid-template-columns:1fr 1fr 1fr; }

 .panel { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:20px; }
 .panel-head { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; color:var(--text2); margin-bottom:4px; display:flex; align-items:center; gap:6px; }
 .panel-head .dot { width:6px; height:6px; border-radius:50%; display:inline-block; }
 .panel-desc { font-size:12px; color:var(--text3); margin-bottom:14px; }

 .bars { display:flex; flex-direction:column; gap:6px; }
 .bar-row { display:flex; align-items:center; gap:8px; }
 .bar-lbl { width:110px; text-align:right; font-family:var(--mono); font-size:11px; color:var(--text2); flex-shrink:0; }
 .bar-track { flex:1; height:24px; background:var(--bg2); border-radius:4px; overflow:hidden; }
 .bar-fill { height:100%; border-radius:4px; display:flex; align-items:center; padding-left:8px; transition:width 0.4s ease; min-width:38px; }
 .bar-val { font-family:var(--mono); font-size:10px; font-weight:700; color:#fff; white-space:nowrap; }
 .bar-n { width:52px; text-align:right; font-family:var(--mono); font-size:10px; color:var(--text3); flex-shrink:0; }

 .note { background:var(--bg2); border-left:3px solid var(--accent); padding:12px 14px; border-radius:0 6px 6px 0; font-size:13px; line-height:1.6; margin-top:14px; }
 .note strong { color:var(--accent); }

 table { width:100%; border-collapse:collapse; }
 th { text-align:left; font-family:var(--mono); font-size:9px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--text3); padding:8px 10px; border-bottom:2px solid var(--border2); }
 td { padding:7px 10px; font-family:var(--mono); font-size:12px; border-bottom:1px solid var(--border); }
 tr:last-child td { border-bottom:none; }
 tr:hover td { background:var(--bg2); }
 .up { color:var(--green); font-weight:600; }
 .dn { color:var(--red); font-weight:600; }

 .controls { display:flex; gap:10px; margin-bottom:16px; align-items:center; flex-wrap:wrap; }
 select,.search { font-family:var(--sans); font-size:13px; padding:7px 12px; border:1px solid var(--border2); border-radius:6px; background:var(--surface); color:var(--text); outline:none; transition:border-color 0.15s; }
 select:focus,.search:focus { border-color:var(--accent); }
 select { min-width:160px; cursor:pointer; }
 .search { min-width:220px; }
 .search::placeholder { color:var(--text3); }

 .chips { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:14px; max-height:100px; overflow-y:auto; }
 .chips::-webkit-scrollbar { width:3px; }
 .chips::-webkit-scrollbar-thumb { background:var(--border2); border-radius:2px; }
 .chip { padding:4px 10px; border-radius:4px; font-family:var(--mono); font-size:11px; font-weight:500; color:var(--text2); background:var(--bg2); border:1px solid var(--border); cursor:pointer; transition:all 0.1s; white-space:nowrap; }
 .chip:hover { border-color:var(--accent); color:var(--text); }
 .chip.on { background:var(--accent); color:#fff; border-color:var(--accent); font-weight:600; }

 .clickable { cursor:pointer; }
 .clickable:hover td { background:var(--bg3); }
 .link-name { color:var(--blue); cursor:pointer; text-decoration:none; }
 .link-name:hover { text-decoration:underline; }

 .zone-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:4px; max-width:320px; margin:0 auto; }
 .zone-cell { padding:10px 6px; border-radius:6px; text-align:center; border:1px solid var(--border); }
 .zone-cell .zn { font-family:var(--mono); font-size:9px; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
 .zone-cell .zv { font-family:var(--mono); font-size:14px; font-weight:700; }
 .zone-cell .zp { font-family:var(--mono); font-size:10px; color:var(--text2); margin-top:2px; }

 .framing-summary { display:flex; gap:16px; align-items:center; justify-content:center; margin-bottom:16px; }
 .framing-summary .fs-val { font-family:var(--mono); font-size:28px; font-weight:700; }
 .framing-summary .fs-lbl { font-family:var(--mono); font-size:10px; color:var(--text3); text-transform:uppercase; letter-spacing:0.8px; }

 .p-card { display:flex; align-items:center; gap:16px; border:1px solid var(--border); border-radius:8px; padding:14px 18px; margin-bottom:16px; background:var(--bg2); }
 .p-card .name { font-size:17px; font-weight:700; letter-spacing:-0.3px; }
 .p-card .meta { display:flex; gap:8px; margin-top:3px; font-family:var(--mono); font-size:11px; color:var(--text2); }
 .p-card .meta .t { background:var(--bg3); padding:1px 7px; border-radius:3px; font-weight:500; }
 .p-card .cs { margin-left:auto; font-family:var(--mono); font-size:26px; font-weight:700; padding:4px 14px; border-radius:6px; }

 .mu-tabs { display:flex; gap:4px; margin-bottom:16px; }
 .mu-btn { padding:6px 12px; border-radius:5px; font-family:var(--mono); font-size:11px; font-weight:500; color:var(--text2); background:var(--bg2); border:1px solid var(--border); cursor:pointer; transition:all 0.1s; }
 .mu-btn:hover { border-color:var(--blue); color:var(--text); }
 .mu-btn.on { background:var(--blue); color:#fff; border-color:var(--blue); font-weight:600; }

 .edge-map { position:relative; width:220px; height:260px; margin:0 auto; }
 .edge-zone { position:absolute; display:flex; align-items:center; justify-content:center; flex-direction:column; font-family:var(--mono); border-radius:4px; transition:all 0.2s; }
 .edge-zone .r { font-size:17px; font-weight:700; }
 .edge-zone .n { font-size:9px; opacity:0.6; }
 .sz-outline { position:absolute; border:2px solid var(--border2); border-radius:2px; }

 .team-name { font-size:18px; font-weight:700; margin-bottom:4px; }
 .team-sub { font-family:var(--mono); font-size:11px; color:var(--text2); margin-bottom:16px; }
 .clickable { cursor:pointer; }
 .clickable:hover td:first-child { color:var(--accent); text-decoration:underline; }

 .loading { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:60vh; gap:12px; }
 .spin { width:24px; height:24px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:sp 0.7s linear infinite; }
 @keyframes sp { to { transform:rotate(360deg); } }
 .hidden { display:none !important; }

 /* ── Scouting Card Print ── */
 .scout-card { border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:16px; break-inside:avoid; }
 .scout-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; border-bottom:2px solid var(--border2); padding-bottom:10px; }
 .scout-card-header .sc-name { font-size:16px; font-weight:700; }
 .scout-card-header .sc-meta { font-family:var(--mono); font-size:11px; color:var(--text2); }
 .scout-card-header .sc-rate { font-family:var(--mono); font-size:22px; font-weight:700; }
 .scout-section { margin-bottom:12px; }
 .scout-section-title { font-family:var(--mono); font-size:9px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--text3); margin-bottom:6px; }
 .scout-edge-row { display:flex; gap:8px; margin-bottom:4px; align-items:center; font-family:var(--mono); font-size:12px; }
 .scout-edge-label { width:70px; text-align:right; color:var(--text2); }
 .scout-edge-bar { flex:1; height:20px; background:var(--bg2); border-radius:3px; overflow:hidden; }
 .scout-edge-fill { height:100%; border-radius:3px; display:flex; align-items:center; padding-left:6px; }
 .scout-edge-fill span { font-size:10px; font-weight:700; color:#fff; }
 .scout-edge-n { width:45px; text-align:right; font-size:10px; color:var(--text3); }
 .scout-strategy { background:var(--bg2); border-left:3px solid var(--blue); padding:10px 12px; border-radius:0 6px 6px 0; font-size:12px; line-height:1.6; }
 .scout-strategy strong { color:var(--blue); }
 .btn-print { padding:8px 16px; border-radius:6px; font-family:var(--sans); font-size:13px; font-weight:600; color:#fff; background:var(--accent); border:none; cursor:pointer; transition:background 0.15s; }
 .btn-print:hover { background:#a71d1d; }

 /* ── Player Dev ── */
 .pd-bucket { display:flex; gap:6px; align-items:center; margin-bottom:4px; font-family:var(--mono); font-size:12px; }
 .pd-bucket .pd-label { width:100px; text-align:right; color:var(--text2); font-size:11px; }
 .pd-bucket .pd-bar { flex:1; height:22px; background:var(--bg2); border-radius:3px; overflow:hidden; position:relative; }
 .pd-bucket .pd-fill { height:100%; border-radius:3px; display:flex; align-items:center; padding-left:6px; }
 .pd-bucket .pd-fill span { font-size:10px; font-weight:700; color:#fff; }
 .pd-bucket .pd-tag { width:80px; text-align:center; font-size:9px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; padding:2px 6px; border-radius:3px; }
 .pd-tag-productive { background:var(--green-bg); color:var(--green); }
 .pd-tag-wasted { background:var(--red-bg); color:var(--red); }
 .pd-tag-mixed { background:var(--orange-bg); color:var(--orange); }
 .pd-summary-row { display:flex; gap:16px; margin-bottom:16px; }
 .pd-summary-box { flex:1; text-align:center; padding:14px; border:1px solid var(--border); border-radius:8px; }
 .pd-summary-box .pd-sv { font-family:var(--mono); font-size:24px; font-weight:700; }
 .pd-summary-box .pd-sl { font-family:var(--mono); font-size:9px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; color:var(--text3); margin-bottom:4px; }

 /* ── Front Office ── */
 .fo-compare-card { border:1px solid var(--border); border-radius:8px; padding:16px; background:var(--surface); }
 .fo-compare-card .fo-name { font-size:15px; font-weight:700; margin-bottom:2px; }
 .fo-compare-card .fo-team { font-family:var(--mono); font-size:11px; color:var(--text2); margin-bottom:10px; }
 .fo-metric { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid var(--border); }
 .fo-metric:last-child { border-bottom:none; }
 .fo-metric .fo-ml { font-family:var(--mono); font-size:10px; color:var(--text3); text-transform:uppercase; letter-spacing:0.5px; }
 .fo-metric .fo-mv { font-family:var(--mono); font-size:16px; font-weight:700; }
 .fo-delta { display:inline-block; font-family:var(--mono); font-size:11px; font-weight:600; padding:2px 6px; border-radius:3px; margin-left:6px; }
 .fo-delta.pos { background:var(--green-bg); color:var(--green); }
 .fo-delta.neg { background:var(--red-bg); color:var(--red); }
 .fo-delta.neu { background:var(--bg2); color:var(--text3); }
 .fo-add-btn { padding:6px 14px; border-radius:6px; font-family:var(--mono); font-size:11px; font-weight:600; color:var(--blue); background:var(--blue-bg); border:1px solid transparent; cursor:pointer; transition:all 0.1s; }
 .fo-add-btn:hover { border-color:var(--blue); }
 .fo-add-btn.on { background:var(--accent); color:#fff; border-color:var(--accent); }
 .fo-compare-grid { display:grid; gap:16px; margin-top:16px; }

 @media print {
  body { background:#fff; }
  .header, .tabs, .controls, .stats, .btn-print,
  #tab-overview, #tab-platoon, #tab-pitchers, #tab-team, #tab-catchers,
  #tab-playerdev, #tab-frontoffice { display:none !important; }
  #tab-scout { display:block !important; }
  .scout-card { border:1px solid #ccc; page-break-inside:avoid; }
  .content { padding:0 16px; }
  .scout-print-header { display:block !important; }
 }
 .scout-print-header { display:none; margin-bottom:16px; }
 .scout-print-header h2 { font-size:18px; font-weight:700; }
 .scout-print-header p { font-size:12px; color:var(--text2); }

 @media (max-width:860px) {
  .grid-2 { grid-template-columns:1fr; }
  .grid-3 { grid-template-columns:1fr; }
  .header,.content { padding-left:16px; padding-right:16px; }
  .stats { flex-wrap:wrap; }
  .stat { min-width:140px; }
  .pd-summary-row { flex-wrap:wrap; }
  .pd-summary-box { min-width:140px; }
 }
</style>
</head>
<body>

<div id="load" class="loading">
 <div class="spin"></div>
 <span style="font-size:13px;color:var(--text2)">Loading shadow zone data…</span>
</div>

<div id="app" class="hidden">
 <div class="header">
  <div class="header-row">
   <h1>Shadow Zone Module</h1>
   <span class="tag" id="tag">2025</span>
  </div>
  <p>Pitch sequence effects and platoon edge vulnerability — <span id="hc"></span> qualified pitchers, <span id="hd"></span> shadow zone called decisions.</p>
 </div>

 <div class="content">
  <div class="stats" id="stats"></div>

  <div class="tabs" id="tb">
   <button class="tab active" data-tab="overview">Overview</button>
   <button class="tab" data-tab="platoon">Platoon Splits</button>
   <button class="tab" data-tab="pitchers">Pitcher Profiles</button>
   <button class="tab" data-tab="team">Team View</button>
   <button class="tab" data-tab="catchers">Catchers</button>
   <button class="tab" data-tab="scout">Scouting Card</button>
   <button class="tab" data-tab="playerdev">Player Dev</button>
   <button class="tab" data-tab="frontoffice">Front Office</button>
  </div>

  <!-- ── OVERVIEW ── -->
  <div id="tab-overview" class="tp">
   <div class="grid grid-2">
    <div class="panel">
     <div class="panel-head"><span class="dot" style="background:var(--accent)"></span> CS Rate by Sequence Category</div>
     <div class="panel-desc">Called strike rate based on what pitch type preceded the current pitch.</div>
     <div id="ov-bars"></div>
     <div class="note" id="ov-note"></div>
    </div>
    <div class="panel">
     <div class="panel-head"><span class="dot" style="background:var(--blue)"></span> Sequence Pair Rates</div>
     <div class="panel-desc">Specific prev→current pitch category CS rates across the league.</div>
     <div id="ov-tbl"></div>
    </div>
   </div>
  </div>

  <!-- ── PLATOON ── -->
  <div id="tab-platoon" class="tp hidden">
   <div class="controls" style="margin-bottom:12px;">
    <select id="pl-team" onchange="setPLTeam(this.value)"><option value="LEAGUE">League Average</option></select>
    <span id="pl-team-label" style="font-family:var(--mono);font-size:11px;color:var(--text3);"></span>
   </div>
   <div class="mu-tabs" id="mu"></div>
   <div class="grid grid-2">
    <div class="panel">
     <div class="panel-head"><span class="dot" style="background:var(--blue)"></span> Edge CS Rate Map</div>
     <div class="panel-desc">Called strike rate by zone edge. Higher = more umpire strikes at that edge.</div>
     <div style="display:flex;justify-content:center;padding:16px 0;">
      <div class="edge-map">
       <div class="sz-outline" style="left:36px;top:26px;width:148px;height:208px;"></div>
       <div class="edge-zone" id="ez-top" style="left:54px;top:0;width:112px;height:40px;"></div>
       <div class="edge-zone" id="ez-bot" style="left:54px;top:220px;width:112px;height:40px;"></div>
       <div class="edge-zone" id="ez-in" style="left:0;top:72px;width:50px;height:116px;"></div>
       <div class="edge-zone" id="ez-out" style="left:170px;top:72px;width:50px;height:116px;"></div>
       <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-family:var(--mono);font-size:9px;color:var(--text3);text-align:center;letter-spacing:1px;">STRIKE<br>ZONE</div>
      </div>
     </div>
    </div>
    <div class="panel">
     <div class="panel-head"><span class="dot" style="background:var(--green)"></span> Edge Vulnerability</div>
     <div class="panel-desc">Which edges are most/least protected in this matchup.</div>
     <div id="pl-bars"></div>
     <div class="note" id="pl-note"></div>
    </div>
   </div>
   <div class="panel" style="margin-top:16px;">
    <div class="panel-head"><span class="dot" style="background:var(--orange)"></span> All Matchup Comparison</div>
    <div id="pl-cmp"></div>
   </div>
  </div>

  <!-- ── PITCHER PROFILES ── -->
  <div id="tab-pitchers" class="tp hidden">
   <div class="controls">
    <select id="p-team" onchange="filt()"><option value="ALL">All Teams</option></select>
    <input class="search" id="p-srch" type="text" placeholder="Search pitcher…" oninput="filt()">
   </div>
   <div class="chips" id="p-chips"></div>
   <div id="p-card"></div>
   <div class="grid grid-2">
    <div class="panel">
     <div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Sequence Profile</div>
     <div class="panel-desc">Shadow zone CS rate by pitch sequencing.</div>
     <div id="p-seq"></div>
    </div>
    <div class="panel">
     <div class="panel-head"><span class="dot" style="background:var(--blue)"></span> Platoon Edge Profile</div>
     <div class="panel-desc">Called strike rate by edge and batter handedness.</div>
     <div id="p-plat"></div>
    </div>
   </div>
   <div class="panel" style="margin-top:16px;">
    <div class="panel-head"><span class="dot" style="background:var(--orange)"></span> Catcher Battery Splits</div>
    <div class="panel-desc">How this pitcher's shadow zone CS rate changes by catcher (min 30 decisions).</div>
    <div id="p-catchers"></div>
   </div>
   <div class="panel" style="margin-top:16px;">
    <div class="panel-head"><span class="dot" style="background:var(--green)"></span> Scouting Note</div>
    <div class="note" id="p-note"></div>
   </div>
  </div>

  <!-- ── TEAM VIEW ── -->
  <div id="tab-team" class="tp hidden">
   <div class="controls">
    <select id="t-sel" onchange="teamView()"><option value="">Select a team…</option></select>
   </div>
   <div id="t-body"></div>
  </div>

  <!-- ── CATCHERS ── -->
  <div id="tab-catchers" class="tp hidden">
   <div class="controls">
    <select id="c-team" onchange="filtC()"><option value="ALL">All Teams</option></select>
    <input class="search" id="c-srch" type="text" placeholder="Search catcher…" oninput="filtC()">
   </div>
   <div id="c-rank"></div>
   <div id="c-detail" class="hidden">
    <div id="c-card"></div>
    <div class="grid grid-2">
     <div class="panel">
      <div class="panel-head"><span class="dot" style="background:var(--blue)"></span> Edge Profile</div>
      <div class="panel-desc">Called strike rate by shadow zone edge for this catcher.</div>
      <div id="c-edges"></div>
     </div>
     <div class="panel">
      <div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Pitcher Battery Splits</div>
      <div class="panel-desc">How this catcher's CS rate varies by pitcher (min 30 decisions).</div>
      <div id="c-pairs"></div>
     </div>
    </div>
    <div class="panel" style="margin-top:16px;">
     <div class="panel-head"><span class="dot" style="background:var(--orange)"></span> Savant Framing</div>
     <div class="panel-desc">Run values and CS% by shadow zone region (Baseball Savant catcher framing).</div>
     <div id="c-framing"></div>
    </div>
    <div class="panel" style="margin-top:16px;">
     <div class="panel-head"><span class="dot" style="background:var(--green)"></span> Framing Note</div>
     <div class="note" id="c-note"></div>
    </div>
   </div>
  </div>

  <!-- ── SCOUTING CARD ── -->
  <div id="tab-scout" class="tp hidden">
   <div class="scout-print-header" id="scout-print-head">
    <h2 id="scout-print-title"></h2>
    <p id="scout-print-sub"></p>
   </div>
   <div class="controls">
    <select id="sc-team" onchange="buildScoutCards()"><option value="">Select opponent…</option></select>
    <button class="btn-print" onclick="printScoutCards()">Print Scouting Card</button>
   </div>
   <div id="sc-body"></div>
  </div>

  <!-- ── PLAYER DEV ── -->
  <div id="tab-playerdev" class="tp hidden">
   <div class="controls">
    <select id="pd-team" onchange="filtPD()"><option value="ALL">All Teams</option></select>
    <select id="pd-catcher" onchange="buildPDReport()"><option value="">Select catcher…</option></select>
   </div>
   <div id="pd-body"></div>
  </div>

  <!-- ── FRONT OFFICE ── -->
  <div id="tab-frontoffice" class="tp hidden">
   <div class="controls">
    <select id="fo-sort" onchange="buildFOLeaderboard()">
     <option value="uss_runs">Sort: USS Runs</option>
     <option value="trad_runs">Sort: Traditional Framing Runs</option>
     <option value="cs_rate">Sort: Shadow CS Rate</option>
    </select>
    <button class="fo-add-btn" id="fo-compare-btn" onclick="toggleFOCompare()">Compare Selected</button>
    <button class="fo-add-btn" onclick="clearFOCompare()" style="color:var(--text2);background:var(--bg2);">Clear</button>
   </div>
   <div id="fo-leaderboard"></div>
   <div id="fo-compare" class="hidden"></div>
  </div>

 </div><!-- /content -->
</div><!-- /app -->

<script>
let D,curP,curC,curMU='LHP_vs_RHB';
var pcpNorm={};
var pitcherToCatchers={};
var foSelected=new Set(); // front office comparison selections

(async()=>{
 try{
  const r=await fetch('./shadow_zone_2025_full.json');
  if(!r.ok) throw new Error('HTTP '+r.status);
  D=await r.json();
  boot();
 }catch(e){
  document.getElementById('load').innerHTML='<div style="color:var(--red)">Failed: '+e.message+'</div><div style="color:var(--text3);font-size:12px;margin-top:6px">Ensure shadow_zone_2025_full.json is in the same directory.</div>';
 }
})();

function boot(){
 // Build case-normalization map for pitcherCatcherPairs
 if(D.pitcherCatcherPairs && D.catcherMeta){
  const metaLower={};
  Object.keys(D.catcherMeta).forEach(n=>{ metaLower[n.toLowerCase()]=n; });
  const rawPCP=D.pitcherCatcherPairs;
  D.pitcherCatcherPairs={};
  Object.entries(rawPCP).forEach(([k,v])=>{
   const proper=metaLower[k]||k;
   D.pitcherCatcherPairs[proper]=v;
  });
 }

 // Build reverse index: pitcher → catchers
 if(D.pitcherCatcherPairs){
  Object.entries(D.pitcherCatcherPairs).forEach(([catcher,pitchers])=>{
   pitchers.forEach(p=>{
    if(!pitcherToCatchers[p.pitcher]) pitcherToCatchers[p.pitcher]=[];
    pitcherToCatchers[p.pitcher].push({catcher:catcher, rate:p.rate, n:p.n});
   });
  });
  Object.values(pitcherToCatchers).forEach(arr=>arr.sort((a,b)=>b.n-a.n));
 }

 document.getElementById('load').classList.add('hidden');
 document.getElementById('app').classList.remove('hidden');

 const s=D.summary;
 document.getElementById('tag').textContent=s.season;
 document.getElementById('hc').textContent=s.qualified_pitchers;
 document.getElementById('hd').textContent=s.total_shadow_called.toLocaleString();

 document.getElementById('stats').innerHTML=[
  st('Pitches',s.total_pitches.toLocaleString(),s.qualified_pitchers+' pitchers'),
  st('Shadow Zone',s.total_shadow.toLocaleString(),s.shadow_pct+'% of all'),
  st('Called Decisions',s.total_shadow_called.toLocaleString(),'shadow takes'),
  st('CS Rate',pc(s.overall_cs_rate),'league avg'),
  st('Seq Signal','+'+s.sequence_signal_pp+'pp','1st pitch vs same-cat'),
 ].join('');

 // Tab navigation
 document.querySelectorAll('#tb .tab').forEach(b=>{
  b.onclick=()=>{
   document.querySelectorAll('#tb .tab').forEach(t=>t.classList.remove('active'));
   document.querySelectorAll('.tp').forEach(t=>t.classList.add('hidden'));
   b.classList.add('active');
   document.getElementById('tab-'+b.dataset.tab).classList.remove('hidden');
  };
 });

 const teams=[...new Set(Object.values(D.pitcherMeta).map(m=>m.team))].sort();
 ['p-team','t-sel'].forEach(id=>{
  const el=document.getElementById(id);
  const f=id==='p-team'?'<option value="ALL">All Teams</option>':'<option value="">Select a team…</option>';
  el.innerHTML=f+teams.map(t=>'<option value="'+t+'">'+t+'</option>').join('');
 });

 // Catcher team dropdowns
 if(D.catcherMeta){
  const cTeams=[...new Set(Object.values(D.catcherMeta).map(m=>m.team))].sort();
  ['c-team','pd-team'].forEach(id=>{
   const el=document.getElementById(id);
   if(el) el.innerHTML='<option value="ALL">All Teams</option>'+cTeams.map(t=>'<option value="'+t+'">'+t+'</option>').join('');
  });
 }

 // All teams for scouting & front office
 const allTeams=[...new Set([
  ...Object.values(D.pitcherMeta).map(m=>m.team),
  ...(D.catcherMeta?Object.values(D.catcherMeta).map(m=>m.team):[])
 ])].sort();
 const scEl=document.getElementById('sc-team');
 scEl.innerHTML='<option value="">Select opponent…</option>'+allTeams.map(t=>'<option value="'+t+'">'+t+'</option>').join('');

 document.getElementById('mu').innerHTML=
  ['LHP_vs_RHB','LHP_vs_LHB','RHP_vs_RHB','RHP_vs_LHB'].map((m,i)=>
   '<button class="mu-btn'+(i===0?' on':'')+'" onclick="setMU(\''+m+'\',this)">'+m.replace(/_/g,' ')+'</button>'
  ).join('');

 // Platoon team dropdown
 if(D.teamMatchupEdges){
  const plTeams=Object.keys(D.teamMatchupEdges).sort();
  const plEl=document.getElementById('pl-team');
  plEl.innerHTML='<option value="LEAGUE">League Average</option>'+plTeams.map(t=>'<option value="'+t+'">'+t+'</option>').join('');
 }

 buildOV();
 setMU('LHP_vs_RHB',document.querySelector('.mu-btn'));
 buildCmp();
 filt();
 filtC();
 filtPD();
 buildFOLeaderboard();
}

/* ── Helpers ── */
function st(l,v,s){
 return '<div class="stat"><div class="label">'+l+'</div><div class="val">'+v+'</div><div class="sub">'+s+'</div></div>';
}
function pc(v){ return (v*100).toFixed(1)+'%'; }

function br(label,rate,color,n){
 const w=Math.max(rate*180,8);
 return '<div class="bar-row"><div class="bar-lbl">'+label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+w+'%;background:'+color+'"><span class="bar-val">'+pc(rate)+'</span></div></div>'+(n!=null?'<div class="bar-n">n='+n.toLocaleString()+'</div>':'')+'</div>';
}
function shortN(n){const p=n.split(', ');return p.length===2?p[1]+' '+p[0]:n;}
function esc(s){return s.replace(/'/g,"\\'");}

/** Read USS data from pipeline — RE288-weighted, confidence-thresholded */
function getUSS(name){
 const m=D.catcherMeta[name];
 if(!m) return {uss_runs:0,trad_runs:0,stolen_strikes:0,uss:0,contested:0,uss_pct:0};
 const ussRuns=m.uss_runs||0;
 const tradRuns=D.catcherFraming&&D.catcherFraming[name]?D.catcherFraming[name].rv_tot:0;
 return {
  uss_runs:ussRuns,
  trad_runs:tradRuns,
  stolen_strikes:m.stolen_strikes||0,
  uss:m.uss||0,
  contested:m.contested||0,
  uss_pct:m.uss_pct||0
 };
}

/* ── OVERVIEW ── */
function buildOV(){
 const s=D.summary;
 document.getElementById('ov-bars').innerHTML='<div class="bars">'+
  [{l:'First Pitch',r:s.first_pitch_cs_rate,c:'var(--accent)'},{l:'Diff Category',r:s.diff_cat_cs_rate,c:'var(--blue)'},{l:'Same Category',r:s.same_cat_cs_rate,c:'var(--text3)'}]
  .map(c=>br(c.l,c.r,c.c)).join('')+'</div>';

 document.getElementById('ov-note').innerHTML='<strong>First pitches get more strikes.</strong> Umpires call shadow zone first pitches as strikes '+pc(s.first_pitch_cs_rate)+' — '+s.sequence_signal_pp+'pp higher than same-category sequences.';

 const agg={};
 for(const nm in D.pitcherSequences) D.pitcherSequences[nm].forEach(x=>{
  if(!agg[x.seq]) agg[x.seq]={cs:0,n:0};
  agg[x.seq].cs+=Math.round(x.rate*x.n);
  agg[x.seq].n+=x.n;
 });
 const rows=Object.entries(agg).map(([seq,d])=>({seq,rate:d.cs/d.n,n:d.n})).sort((a,b)=>b.rate-a.rate);

 const seqTotal=rows.reduce((a,r)=>({cs:a.cs+Math.round(r.rate*r.n),n:a.n+r.n}),{cs:0,n:0});
 const avg=D.summary.non_first_cs_rate||(seqTotal.n>0?seqTotal.cs/seqTotal.n:D.summary.overall_cs_rate);

 document.getElementById('ov-tbl').innerHTML='<table><thead><tr><th>Sequence</th><th>CS Rate</th><th>n</th><th>vs Avg</th></tr></thead><tbody>'+
  rows.map(r=>{
   const df=((r.rate-avg)*100).toFixed(1);
   const c=r.rate>avg+0.015?'up':r.rate<avg-0.015?'dn':'';
   const dc=parseFloat(df)>0?'up':parseFloat(df)<0?'dn':'';
   return '<tr><td>'+r.seq+'</td><td class="'+c+'">'+pc(r.rate)+'</td><td>'+r.n.toLocaleString()+'</td><td class="'+dc+'">'+(parseFloat(df)>0?'+':'')+df+'pp</td></tr>';
  }).join('')+'</tbody></table>';
}

/* ── PLATOON ── */
function setMU(mu,btn){
 curMU=mu;
 document.querySelectorAll('.mu-btn').forEach(b=>b.classList.remove('on'));
 if(btn)btn.classList.add('on');

 const team=curPLTeam||'LEAGUE';
 const isTeam=team!=='LEAGUE';
 const ld=D.leagueMatchupEdges[mu]||{};
 const d=isTeam&&D.teamMatchupEdges&&D.teamMatchupEdges[team]?D.teamMatchupEdges[team][mu]||{}:ld;
 const es=['inside','outside','top','bottom'];
 const ids={inside:'ez-in',outside:'ez-out',top:'ez-top',bottom:'ez-bot'};

 es.forEach(e=>{
  const el=document.getElementById(ids[e]);
  const v=d[e]; const lv=ld[e];
  if(!v){el.innerHTML='<span style="color:var(--text3);font-size:10px">—</span>';el.style.background='';el.style.border='';return;}
  const p=(v.rate*100).toFixed(1);
  const col=v.rate>0.48?'var(--red)':v.rate>0.40?'var(--orange)':'var(--green)';
  const bg=v.rate>0.48?'var(--red-bg)':v.rate>0.40?'var(--orange-bg)':'var(--green-bg)';
  el.style.background=bg; el.style.border='1px solid '+col;
  let html='<span class="r" style="color:'+col+'">'+p+'%</span>';
  if(isTeam&&lv){
   const diff=((v.rate-lv.rate)*100).toFixed(1);
   const dc=parseFloat(diff)>0?'color:var(--green)':parseFloat(diff)<0?'color:var(--red)':'color:var(--text3)';
   html+='<span class="n" style="'+dc+';font-weight:600">'+(parseFloat(diff)>0?'+':'')+diff+'pp</span>';
  } else {
   html+='<span class="n">n='+v.n.toLocaleString()+'</span>';
  }
  el.innerHTML=html;
 });

 const sorted=es.filter(e=>d[e]).sort((a,b)=>d[b].rate-d[a].rate);
 document.getElementById('pl-bars').innerHTML='<div class="bars">'+sorted.map(e=>{
  const v=d[e];
  const col=v.rate>0.48?'var(--red)':v.rate>0.40?'var(--orange)':'var(--green)';
  let label=e.charAt(0).toUpperCase()+e.slice(1)+' Edge';
  if(isTeam&&ld[e]){
   const diff=((v.rate-ld[e].rate)*100).toFixed(1);
   label+=' ('+(parseFloat(diff)>0?'+':'')+diff+'pp vs lg)';
  }
  return br(label,v.rate,col,v.n);
 }).join('')+'</div>';

 const best=sorted[0],worst=sorted[sorted.length-1];
 const spread=((d[best].rate-d[worst].rate)*100).toFixed(1);
 let notePrefix=mu.replace(/_/g,' ');
 if(isTeam) notePrefix=team+' — '+notePrefix;
 document.getElementById('pl-note').innerHTML='<strong>'+notePrefix+':</strong> '+best+' edge highest at '+pc(d[best].rate)+'. '+worst+' edge lowest at '+pc(d[worst].rate)+'. Spread: '+spread+'pp.';
}

var curPLTeam='LEAGUE';
function setPLTeam(team){
 curPLTeam=team;
 const lbl=document.getElementById('pl-team-label');
 lbl.textContent=team==='LEAGUE'?'':'Showing team edge rates vs league baseline';
 setMU(curMU,document.querySelector('.mu-btn.on'));
 buildCmp();
}

function buildCmp(){
 const mus=['LHP_vs_RHB','LHP_vs_LHB','RHP_vs_RHB','RHP_vs_LHB'],es=['inside','outside','top','bottom'];
 const team=curPLTeam||'LEAGUE';
 const isTeam=team!=='LEAGUE';
 const le=D.leagueMatchupEdges;
 const te=isTeam&&D.teamMatchupEdges?D.teamMatchupEdges[team]:null;

 let h='<table><thead><tr><th>Matchup</th><th>Inside</th><th>Outside</th><th>Top</th><th>Bottom</th><th>Highest</th></tr></thead><tbody>';
 mus.forEach(m=>{
  const d=isTeam&&te?te[m]:le[m];
  if(!d)return;
  let mx='',mxR=0;
  es.forEach(e=>{if(d[e]&&d[e].rate>mxR){mxR=d[e].rate;mx=e;}});
  h+='<tr><td>'+m.replace(/_/g,' ')+'</td>';
  es.forEach(e=>{
   const v=d[e];
   if(!v){h+='<td>—</td>';return;}
   const c=e===mx?'up':v.rate<0.35?'dn':'';
   let cell=pc(v.rate);
   if(isTeam&&le[m]&&le[m][e]){
    const diff=((v.rate-le[m][e].rate)*100).toFixed(1);
    const dc=parseFloat(diff)>0?'up':parseFloat(diff)<0?'dn':'';
    cell+=' <span class="'+dc+'" style="font-size:10px">('+(parseFloat(diff)>0?'+':'')+diff+')</span>';
   }
   h+='<td class="'+c+'">'+cell+'</td>';
  });
  h+='<td style="color:var(--accent);font-weight:600">'+mx.charAt(0).toUpperCase()+mx.slice(1)+' ('+pc(mxR)+')</td></tr>';
 });
 document.getElementById('pl-cmp').innerHTML=h+'</tbody></table>';
}

/* ── PITCHER PROFILES ── */
function filt(){
 const team=document.getElementById('p-team').value;
 const q=document.getElementById('p-srch').value.toLowerCase().trim();
 let ps=Object.keys(D.pitcherMeta);
 if(team!=='ALL')ps=ps.filter(n=>D.pitcherMeta[n].team===team);
 if(q)ps=ps.filter(n=>n.toLowerCase().includes(q));
 ps.sort((a,b)=>(D.pitcherMeta[b].cs_rate||0)-(D.pitcherMeta[a].cs_rate||0));

 const el=document.getElementById('p-chips');
 if(!ps.length){el.innerHTML='<span style="color:var(--text3);font-size:12px">No pitchers match.</span>';return;}
 el.innerHTML=ps.map((p,i)=>{
  const on=(curP===p||(!curP&&i===0))?' on':'';
  return '<button class="chip'+on+'" onclick="selP(\''+esc(p)+'\',this)">'+shortN(p)+'</button>';
 }).join('');
 if(!curP||!ps.includes(curP))selP(ps[0],el.querySelector('.chip'));
}

function selP(name,btn){
 curP=name;
 document.querySelectorAll('#p-chips .chip').forEach(c=>c.classList.remove('on'));
 if(btn)btn.classList.add('on');

 const m=D.pitcherMeta[name],seqs=D.pitcherSequences[name]||[],plat=D.pitcherPlatoon[name]||[],avg=D.summary.overall_cs_rate;
 const diff=m.cs_rate-avg;
 const col=diff>0.04?'var(--green)':diff<-0.04?'var(--red)':'var(--orange)';
 const bg=diff>0.04?'var(--green-bg)':diff<-0.04?'var(--red-bg)':'var(--orange-bg)';

 document.getElementById('p-card').innerHTML='<div class="p-card"><div><div class="name">'+name+'</div><div class="meta"><span class="t">'+m.team+'</span><span class="t">'+m.hand+'HP</span><span>'+m.shadow_decisions+' decisions</span></div></div><div class="cs" style="color:'+col+';background:'+bg+'">'+pc(m.cs_rate)+'</div></div>';

 if(seqs.length){
  document.getElementById('p-seq').innerHTML='<div class="bars">'+seqs.map(s=>{
   const c=s.rate>avg+0.05?'var(--green)':s.rate<avg-0.05?'var(--red)':'var(--text3)';
   return br(s.seq,s.rate,c,s.n);
  }).join('')+'</div>';
 }else document.getElementById('p-seq').innerHTML='<span style="color:var(--text3);font-size:12px">Insufficient data.</span>';

 if(plat.length){
  document.getElementById('p-plat').innerHTML='<table><thead><tr><th>Matchup</th><th>Edge</th><th>CS Rate</th><th>n</th></tr></thead><tbody>'+
   plat.map(p=>{const c=p.rate>avg+0.06?'up':p.rate<avg-0.06?'dn':'';return '<tr><td>'+p.matchup+'</td><td>'+p.edge+'</td><td class="'+c+'">'+pc(p.rate)+'</td><td>'+p.n+'</td></tr>';}).join('')+'</tbody></table>';
 }else document.getElementById('p-plat').innerHTML='<span style="color:var(--text3);font-size:12px">Insufficient data.</span>';

 document.getElementById('p-note').innerHTML=genNote(name,m,seqs,plat,avg);

 // Catcher battery splits
 const catchers=pitcherToCatchers[name];
 if(catchers&&catchers.length){
  const sorted=[...catchers].sort((a,b)=>b.rate-a.rate);
  document.getElementById('p-catchers').innerHTML=
   '<table><thead><tr><th>Catcher</th><th>CS Rate</th><th>n</th><th>vs Pitcher Avg</th></tr></thead><tbody>'+
   sorted.map(c=>{
    const df=((c.rate-m.cs_rate)*100).toFixed(1);
    const cl=c.rate>m.cs_rate+0.03?'up':c.rate<m.cs_rate-0.03?'dn':'';
    const hasMeta=D.catcherMeta&&D.catcherMeta[c.catcher];
    const nameCell=hasMeta?'<span class="link-name" onclick="jumpC(\''+esc(c.catcher)+'\')">'+c.catcher+'</span>':c.catcher;
    return '<tr><td>'+nameCell+'</td><td class="'+cl+'">'+pc(c.rate)+'</td><td>'+c.n+'</td><td class="'+cl+'">'+(parseFloat(df)>0?'+':'')+df+'pp</td></tr>';
   }).join('')+'</tbody></table>';
 }else{
  document.getElementById('p-catchers').innerHTML='<span style="color:var(--text3);font-size:12px">No battery split data (needs 2+ catchers with 30+ decisions each).</span>';
 }
}

function genNote(name,m,seqs,plat,avg){
 const parts=[],d=m.cs_rate-avg,dp=(d*100).toFixed(1);
 if(d>0.06)parts.push('<strong>Elite shadow zone pitcher</strong> — '+pc(m.cs_rate)+' CS rate, +'+dp+'pp above league average.');
 else if(d>0.02)parts.push('<strong>Above-average shadow zone pitcher</strong> — '+pc(m.cs_rate)+' (+'+dp+'pp).');
 else if(d>-0.02)parts.push('<strong>League-average shadow zone profile</strong> — '+pc(m.cs_rate)+'.');
 else parts.push('<strong>Below-average shadow zone pitcher</strong> — '+pc(m.cs_rate)+' ('+dp+'pp vs avg).');

 if(seqs.length){
  const best=seqs[0],worst=seqs[seqs.length-1];
  parts.push('<strong>Best sequence:</strong> '+best.seq+' at '+pc(best.rate)+' (n='+best.n+').');
  const sp=((best.rate-worst.rate)*100).toFixed(1);
  if(parseFloat(sp)>8)parts.push('Sequence spread: '+sp+'pp — '+worst.seq+' drops to '+pc(worst.rate)+'.');
 }
 if(plat.length){
  const s=[...plat].sort((a,b)=>b.rate-a.rate),hi=s[0],lo=s[s.length-1];
  parts.push('<strong>Strongest edge:</strong> '+hi.edge+' vs '+hi.matchup.split(' vs ')[1]+' at '+pc(hi.rate)+' (n='+hi.n+').');
  parts.push('<strong>Challenge vulnerability:</strong> '+lo.edge+' in '+lo.matchup+' at '+pc(lo.rate)+(lo.rate<0.30?' — batters should challenge aggressively.':'.'));
 }
 return parts.join(' ');
}

/* ── TEAM VIEW ── */
function teamView(){
 const team=document.getElementById('t-sel').value,el=document.getElementById('t-body');
 if(!team){el.innerHTML='';return;}
 const avg=D.summary.overall_cs_rate;
 const ps=Object.entries(D.pitcherMeta).filter(([_,m])=>m.team===team).sort((a,b)=>b[1].cs_rate-a[1].cs_rate);
 const te=D.teamMatchupEdges[team];

 let tDec=0,tCS=0,tPitches=0,tShadow=0;
 ps.forEach(([_,m])=>{tDec+=m.shadow_decisions;tCS+=Math.round(m.cs_rate*m.shadow_decisions);tPitches+=m.total_pitches;tShadow+=m.shadow_pitches;});
 const tRate=tDec>0?tCS/tDec:0;
 const tDiff=((tRate-avg)*100).toFixed(1);
 const tCol=tRate>avg+0.02?'var(--green)':tRate<avg-0.02?'var(--red)':'var(--text)';

 const best=ps[0],worst=ps[ps.length-1];

 let h='<div class="team-name">'+team+'</div><div class="team-sub">'+ps.length+' qualified pitchers</div>';
 h+='<div class="stats" style="margin:0 0 16px">';
 h+=st('Team CS Rate','<span style="color:'+tCol+'">'+pc(tRate)+'</span>','<span style="color:'+tCol+'">'+(parseFloat(tDiff)>0?'+':'')+tDiff+'pp vs league</span>');
 h+=st('Decisions',tDec.toLocaleString(),tShadow.toLocaleString()+' shadow pitches');
 h+=st('Staff Best',best?pc(best[1].cs_rate):'—',best?best[0]:'');
 h+=st('Staff Worst',worst?pc(worst[1].cs_rate):'—',worst?worst[0]:'');
 h+='</div>';

 h+='<div class="panel" style="margin-bottom:16px"><div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Staff Rankings</div>'+
  '<table><thead><tr><th>Pitcher</th><th>Hand</th><th>Decisions</th><th>CS Rate</th><th>vs League</th><th>vs Team</th></tr></thead><tbody>'+
  ps.map(([n,m])=>{
   const dfL=((m.cs_rate-avg)*100).toFixed(1),dfT=((m.cs_rate-tRate)*100).toFixed(1);
   const cL=m.cs_rate>avg+0.02?'up':m.cs_rate<avg-0.02?'dn':'';
   const cT=m.cs_rate>tRate+0.02?'up':m.cs_rate<tRate-0.02?'dn':'';
   return '<tr class="clickable" onclick="jumpP(\''+esc(n)+'\')"><td>'+n+'</td><td>'+m.hand+'HP</td><td>'+m.shadow_decisions+'</td><td class="'+cL+'">'+pc(m.cs_rate)+'</td><td class="'+cL+'">'+(parseFloat(dfL)>0?'+':'')+dfL+'pp</td><td class="'+cT+'">'+(parseFloat(dfT)>0?'+':'')+dfT+'pp</td></tr>';
  }).join('')+'</tbody></table></div>';

 if(te){
  const le=D.leagueMatchupEdges;
  h+='<div class="panel"><div class="panel-head"><span class="dot" style="background:var(--blue)"></span> Team Matchup Edges</div>'+
   '<table><thead><tr><th>Matchup</th><th>Inside</th><th>Outside</th><th>Top</th><th>Bottom</th></tr></thead><tbody>';
  ['LHP_vs_LHB','LHP_vs_RHB','RHP_vs_RHB','RHP_vs_LHB'].forEach(mu=>{
   const md=te[mu]; if(!md)return;
   const ld=le[mu]||{};
   h+='<tr><td>'+mu.replace(/_/g,' ')+'</td>';
   ['inside','outside','top','bottom'].forEach(e=>{
    if(md[e]){
     const lRate=ld[e]?ld[e].rate:avg;
     const diff=((md[e].rate-lRate)*100).toFixed(1);
     const c=md[e].rate>lRate+0.03?'up':md[e].rate<lRate-0.03?'dn':'';
     h+='<td class="'+c+'">'+pc(md[e].rate)+' <span style="color:var(--text3);font-size:10px">'+(parseFloat(diff)>0?'+':'')+diff+'pp</span></td>';
    } else h+='<td>—</td>';
   });
   h+='</tr>';
  });
  h+='</tbody></table></div>';
 }
 el.innerHTML=h;
}

/* ── NAV JUMPS ── */
function jumpP(name){
 document.querySelectorAll('#tb .tab').forEach(t=>t.classList.remove('active'));
 document.querySelectorAll('.tp').forEach(t=>t.classList.add('hidden'));
 document.querySelectorAll('#tb .tab')[2].classList.add('active');
 document.getElementById('tab-pitchers').classList.remove('hidden');
 const m=D.pitcherMeta[name];
 if(m)document.getElementById('p-team').value=m.team;
 document.getElementById('p-srch').value='';
 filt();
 setTimeout(()=>{document.querySelectorAll('#p-chips .chip').forEach(c=>{if(c.textContent===shortN(name))selP(name,c);});},30);
}

function jumpC(name){
 document.querySelectorAll('#tb .tab').forEach(t=>t.classList.remove('active'));
 document.querySelectorAll('.tp').forEach(t=>t.classList.add('hidden'));
 document.querySelectorAll('#tb .tab')[4].classList.add('active');
 document.getElementById('tab-catchers').classList.remove('hidden');
 const m=D.catcherMeta[name];
 if(m)document.getElementById('c-team').value=m.team;
 document.getElementById('c-srch').value='';
 filtC();
 setTimeout(()=>selC(name),30);
}

/* ── CATCHERS ── */
function filtC(){
 if(!D.catcherMeta){document.getElementById('c-rank').innerHTML='<div class="note" style="border-left-color:var(--text3)">Catcher data not available.</div>';return;}
 const team=document.getElementById('c-team').value;
 const q=document.getElementById('c-srch').value.toLowerCase().trim();
 const avg=D.summary.overall_cs_rate;
 let cs=Object.entries(D.catcherMeta);
 if(team!=='ALL')cs=cs.filter(([_,m])=>m.team===team);
 if(q)cs=cs.filter(([n])=>n.toLowerCase().includes(q));
 cs.sort((a,b)=>b[1].cs_rate-a[1].cs_rate);

 if(!cs.length){document.getElementById('c-rank').innerHTML='<span style="color:var(--text3);font-size:12px">No catchers match.</span>';return;}

 document.getElementById('c-rank').innerHTML=
  '<div class="panel" style="margin-bottom:16px"><div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Catcher Shadow Zone Rankings</div>'+
  '<table><thead><tr><th>Catcher</th><th>Team</th><th>Decisions</th><th>CS Rate</th><th>vs Avg</th></tr></thead><tbody>'+
  cs.map(([n,m])=>{
   const df=((m.cs_rate-avg)*100).toFixed(1);
   const c=m.cs_rate>avg+0.02?'up':m.cs_rate<avg-0.02?'dn':'';
   return '<tr class="clickable" onclick="selC(\''+esc(n)+'\')"><td>'+n+'</td><td>'+m.team+'</td><td>'+m.shadow_decisions+'</td><td class="'+c+'">'+pc(m.cs_rate)+'</td><td class="'+c+'">'+(parseFloat(df)>0?'+':'')+df+'pp</td></tr>';
  }).join('')+'</tbody></table></div>';
}

function selC(name){
 curC=name;
 const m=D.catcherMeta[name];
 const avg=D.summary.overall_cs_rate;
 const diff=m.cs_rate-avg;
 const col=diff>0.04?'var(--green)':diff<-0.04?'var(--red)':'var(--orange)';
 const bg=diff>0.04?'var(--green-bg)':diff<-0.04?'var(--red-bg)':'var(--orange-bg)';

 document.getElementById('c-detail').classList.remove('hidden');
 document.getElementById('c-card').innerHTML=
  '<div class="p-card"><div><div class="name">'+name+'</div><div class="meta"><span class="t">'+m.team+'</span><span>'+m.shadow_decisions+' decisions</span></div></div><div class="cs" style="color:'+col+';background:'+bg+'">'+pc(m.cs_rate)+'</div></div>';

 // Edge profile
 const edges=D.catcherPlatoon?D.catcherPlatoon[name]:null;
 if(edges&&edges.length){
  const sorted=[...edges].sort((a,b)=>b.rate-a.rate);
  document.getElementById('c-edges').innerHTML='<div class="bars">'+
   sorted.map(e=>{
    const c=e.rate>avg+0.05?'var(--green)':e.rate<avg-0.05?'var(--red)':'var(--text3)';
    return br(e.edge+' Edge',e.rate,c,e.n);
   }).join('')+'</div>';
 }else{
  document.getElementById('c-edges').innerHTML='<span style="color:var(--text3);font-size:12px">Insufficient edge data.</span>';
 }

 // Pitcher-catcher pairs
 const pairs=D.pitcherCatcherPairs?D.pitcherCatcherPairs[name]:null;
 if(pairs&&pairs.length){
  const sorted=[...pairs].sort((a,b)=>b.rate-a.rate);
  document.getElementById('c-pairs').innerHTML=
   '<table><thead><tr><th>Pitcher</th><th>CS Rate</th><th>n</th><th>vs Catcher Avg</th></tr></thead><tbody>'+
   sorted.map(p=>{
    const df=((p.rate-m.cs_rate)*100).toFixed(1);
    const c=p.rate>m.cs_rate+0.03?'up':p.rate<m.cs_rate-0.03?'dn':'';
    const hasMeta=D.pitcherMeta&&D.pitcherMeta[p.pitcher];
    const nameCell=hasMeta?'<span class="link-name" onclick="jumpP(\''+esc(p.pitcher)+'\')">'+p.pitcher+'</span>':p.pitcher;
    return '<tr><td>'+nameCell+'</td><td class="'+c+'">'+pc(p.rate)+'</td><td>'+p.n+'</td><td class="'+c+'">'+(parseFloat(df)>0?'+':'')+df+'pp</td></tr>';
   }).join('')+'</tbody></table>';
 }else{
  document.getElementById('c-pairs').innerHTML='<span style="color:var(--text3);font-size:12px">Insufficient battery data.</span>';
 }

 // Savant framing
 const framing=D.catcherFraming?D.catcherFraming[name]:null;
 if(framing){
  const zoneOrder=['top_left','top_mid','top_right','mid_left','mid_right','bot_left','bot_mid','bot_right'];
  const zoneLabels={top_left:'Top L',top_mid:'Top',top_right:'Top R',mid_left:'Left',mid_right:'Right',bot_left:'Bot L',bot_mid:'Bottom',bot_right:'Bot R'};
  const rvCol=framing.rv_tot<=-5?'var(--green)':framing.rv_tot>=5?'var(--red)':'var(--text)';

  let fh='<div class="framing-summary">';
  fh+='<div style="text-align:center"><div class="fs-lbl">Total Run Value</div><div class="fs-val" style="color:'+rvCol+'">'+framing.rv_tot.toFixed(1)+'</div></div>';
  fh+='<div style="text-align:center"><div class="fs-lbl">Shadow CS%</div><div class="fs-val">'+pc(framing.pct_tot)+'</div></div>';
  fh+='<div style="text-align:center"><div class="fs-lbl">Pitches</div><div class="fs-val" style="font-size:20px">'+framing.pitches.toLocaleString()+'</div></div>';
  fh+='</div>';

  fh+='<div class="zone-grid">';
  zoneOrder.forEach((z,i)=>{
   if(i===4) fh+='<div class="zone-cell" style="border:1px dashed var(--border);display:flex;align-items:center;justify-content:center"><span style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1px">ZONE</span></div>';
   const zd=framing.zones[z];
   const rc=zd.rv<=-1?'var(--green)':zd.rv>=1?'var(--red)':'var(--text2)';
   const zbg=zd.rv<=-1?'var(--green-bg)':zd.rv>=1?'var(--red-bg)':'var(--bg2)';
   fh+='<div class="zone-cell" style="background:'+zbg+'"><div class="zn">'+zoneLabels[z]+'</div><div class="zv" style="color:'+rc+'">'+zd.rv.toFixed(0)+'</div><div class="zp">'+pc(zd.pct)+'</div></div>';
  });
  fh+='</div>';
  document.getElementById('c-framing').innerHTML=fh;
 }else{
  document.getElementById('c-framing').innerHTML='<span style="color:var(--text3);font-size:12px">No Savant framing data available for this catcher.</span>';
 }

 document.getElementById('c-note').innerHTML=genCNote(name,m,edges,pairs,avg);
 document.getElementById('c-detail').scrollIntoView({behavior:'smooth',block:'start'});
}

function genCNote(name,m,edges,pairs,avg){
 const parts=[],d=m.cs_rate-avg,dp=(d*100).toFixed(1);
 if(d>0.06)parts.push('<strong>Elite framer</strong> — '+pc(m.cs_rate)+' shadow zone CS rate, +'+dp+'pp above league average.');
 else if(d>0.02)parts.push('<strong>Above-average framer</strong> — '+pc(m.cs_rate)+' (+'+dp+'pp).');
 else if(d>-0.02)parts.push('<strong>League-average framing</strong> — '+pc(m.cs_rate)+'.');
 else parts.push('<strong>Below-average framer</strong> — '+pc(m.cs_rate)+' ('+dp+'pp vs avg).');

 if(edges&&edges.length){
  const s=[...edges].sort((a,b)=>b.rate-a.rate),hi=s[0],lo=s[s.length-1];
  parts.push('<strong>Best edge:</strong> '+hi.edge+' at '+pc(hi.rate)+' (n='+hi.n+').');
  parts.push('<strong>Weakest edge:</strong> '+lo.edge+' at '+pc(lo.rate)+(lo.rate<0.35?' — batters get the benefit here.':'.'));
 }
 if(pairs&&pairs.length){
  const s=[...pairs].sort((a,b)=>b.rate-a.rate);
  const best=s[0],worst=s[s.length-1];
  if(s.length>=2){
   const spread=((best.rate-worst.rate)*100).toFixed(1);
   parts.push('<strong>Battery spread:</strong> '+spread+'pp — best with '+best.pitcher+' ('+pc(best.rate)+'), worst with '+worst.pitcher+' ('+pc(worst.rate)+').');
  }
 }
 return parts.join(' ');
}


/* ═══════════════════════════════════════════════════════════════
   ██  SCOUTING CARD — printable one-pager per opponent battery
   ═══════════════════════════════════════════════════════════════ */

function buildScoutCards(){
 const team=document.getElementById('sc-team').value;
 const el=document.getElementById('sc-body');
 if(!team){el.innerHTML='';return;}
 if(!D.catcherMeta){el.innerHTML='<div class="note" style="border-left-color:var(--text3)">Catcher data not available.</div>';return;}

 const avg=D.summary.overall_cs_rate;

 // Get catchers on this team
 const catchers=Object.entries(D.catcherMeta).filter(([_,m])=>m.team===team).sort((a,b)=>(b[1].uss_runs||0)-(a[1].uss_runs||0));
 if(!catchers.length){el.innerHTML='<span style="color:var(--text3);font-size:12px">No catchers found for '+team+'.</span>';return;}

 // Set print header
 document.getElementById('scout-print-title').textContent='Scouting Card — '+team;
 document.getElementById('scout-print-sub').textContent='Shadow Zone USS Profile — '+D.summary.season+' Season | Generated '+new Date().toLocaleDateString();

 let h='';
 catchers.forEach(([name,meta])=>{
  const edges=D.catcherPlatoon?D.catcherPlatoon[name]:null;
  const framing=D.catcherFraming?D.catcherFraming[name]:null;
  const pairs=D.pitcherCatcherPairs?D.pitcherCatcherPairs[name]:null;
  const ussRuns=meta.uss_runs||0;
  const uss=meta.uss||0;
  const contested=meta.contested||0;
  const stolenTotal=meta.stolen_strikes||0;
  const ussPct=meta.uss_pct||0;
  const ratePct=(meta.cs_rate*100).toFixed(1);
  const col=ussRuns>3?'var(--green)':ussRuns<-1?'var(--red)':'var(--orange)';

  h+='<div class="scout-card">';

  // Header
  h+='<div class="scout-card-header">';
  h+='<div><div class="sc-name">'+name+'</div><div class="sc-meta">'+meta.team+' · '+stolenTotal+' stolen strikes · <strong style="color:'+col+'">'+ussRuns.toFixed(1)+' USS runs</strong> · '+contested+' contestable</div></div>';
  h+='<div class="sc-rate" style="color:'+col+'">'+ratePct+'%</div>';
  h+='</div>';

  // USS vs Contested summary
  if(stolenTotal>0){
   h+='<div class="scout-section">';
   h+='<div class="scout-section-title">USS Breakdown — '+stolenTotal+' Stolen Strikes</div>';
   const ussW=Math.max(ussPct*100,2);
   const contW=Math.max((1-ussPct)*100,2);
   h+='<div style="display:flex;gap:2px;height:28px;border-radius:4px;overflow:hidden;margin-bottom:8px;">';
   h+='<div style="width:'+ussW+'%;background:var(--green);display:flex;align-items:center;justify-content:center;"><span style="font-family:var(--mono);font-size:10px;font-weight:700;color:#fff;">'+uss+' USS ('+(ussPct*100).toFixed(0)+'%)</span></div>';
   h+='<div style="width:'+contW+'%;background:var(--red);display:flex;align-items:center;justify-content:center;"><span style="font-family:var(--mono);font-size:10px;font-weight:700;color:#fff;">'+contested+' Contestable</span></div>';
   h+='</div>';
   h+='<div style="font-family:var(--mono);font-size:10px;color:var(--text3);">USS = uncontested stolen strikes (confidence below Tango challenge threshold for that game state). RE288-weighted run value.</div>';
   h+='</div>';
  }

  // Edge exploitation profile — use pipeline uss_runs per edge
  if(edges&&edges.length){
   const sorted=[...edges].sort((a,b)=>(b.uss_runs||0)-(a.uss_runs||0));
   h+='<div class="scout-section">';
   h+='<div class="scout-section-title">Edge Exploitation — Where USS Runs Accumulate</div>';
   sorted.forEach(e=>{
    const eUss=e.uss_runs!=null?e.uss_runs.toFixed(1):'—';
    const eUssN=e.uss||0;
    const eContested=e.contested||0;
    const eCol=(e.uss_runs||0)>1?'var(--green)':(e.uss_runs||0)<0?'var(--red)':'var(--orange)';
    const w=Math.max(e.rate*180,8);
    h+='<div class="scout-edge-row">';
    h+='<div class="scout-edge-label">'+e.edge+'</div>';
    h+='<div class="scout-edge-bar"><div class="scout-edge-fill" style="width:'+w+'%;background:'+eCol+'"><span>'+pc(e.rate)+' · '+eUssN+'/'+e.n+' USS</span></div></div>';
    h+='<div class="scout-edge-n" style="color:'+eCol+'">'+eUss+' runs</div>';
    h+='</div>';
   });
   h+='</div>';
  }

  // Zone breakdown if available
  if(framing&&framing.zones){
   h+='<div class="scout-section">';
   h+='<div class="scout-section-title">Zone Framing Run Values (Savant)</div>';
   const zoneLabels={top_left:'Top L',top_mid:'Top',top_right:'Top R',mid_left:'Left',mid_right:'Right',bot_left:'Bot L',bot_mid:'Bottom',bot_right:'Bot R'};
   const zones=Object.entries(framing.zones).sort((a,b)=>a[1].rv-b[1].rv);
   h+='<div style="display:flex;flex-wrap:wrap;gap:6px;">';
   zones.forEach(([z,zd])=>{
    const rc=zd.rv<=-1?'var(--green)':zd.rv>=1?'var(--red)':'var(--text2)';
    const zbg=zd.rv<=-1?'var(--green-bg)':zd.rv>=1?'var(--red-bg)':'var(--bg2)';
    h+='<div style="background:'+zbg+';border:1px solid var(--border);border-radius:4px;padding:6px 10px;text-align:center;min-width:70px;">';
    h+='<div style="font-family:var(--mono);font-size:9px;color:var(--text3);">'+zoneLabels[z]+'</div>';
    h+='<div style="font-family:var(--mono);font-size:14px;font-weight:700;color:'+rc+';">'+zd.rv.toFixed(0)+'</div>';
    h+='<div style="font-family:var(--mono);font-size:10px;color:var(--text2);">'+pc(zd.pct)+'</div>';
    h+='</div>';
   });
   h+='</div>';
   h+='</div>';
  }

  // Challenge strategy
  h+='<div class="scout-section">';
  h+='<div class="scout-section-title">Challenge Strategy</div>';
  h+='<div class="scout-strategy">';
  h+=genScoutStrategy(name,meta,edges,framing,avg);
  h+='</div>';
  h+='</div>';

  // Battery pairs — with USS data
  if(pairs&&pairs.length){
   h+='<div class="scout-section">';
   h+='<div class="scout-section-title">Probable Battery Pairs</div>';
   h+='<table><thead><tr><th>Pitcher</th><th>CS Rate</th><th>n</th><th>USS Runs</th><th>Battery Effect</th></tr></thead><tbody>';
   const sorted=[...pairs].sort((a,b)=>b.n-a.n).slice(0,6);
   sorted.forEach(p=>{
    const batteryEffect=((p.rate-meta.cs_rate)*100).toFixed(1);
    const bc=p.rate>meta.cs_rate+0.03?'up':p.rate<meta.cs_rate-0.03?'dn':'';
    const pUss=p.uss_runs!=null?p.uss_runs.toFixed(1):'—';
    h+='<tr><td>'+p.pitcher+'</td><td>'+pc(p.rate)+'</td><td>'+p.n+'</td><td>'+(p.uss_runs!=null&&p.uss_runs>0?'<span class="up">':p.uss_runs!=null&&p.uss_runs<0?'<span class="dn">':'<span>')+pUss+'</span></td><td class="'+bc+'">'+(parseFloat(batteryEffect)>0?'+':'')+batteryEffect+'pp</td></tr>';
   });
   h+='</tbody></table>';
   h+='</div>';
  }

  h+='</div>'; // /scout-card
 });

 el.innerHTML=h;
}

function genScoutStrategy(name,meta,edges,framing,avg){
 const parts=[];
 const ussRuns=meta.uss_runs||0;
 const uss=meta.uss||0;
 const contested=meta.contested||0;
 const stolenTotal=meta.stolen_strikes||0;
 const ussPct=meta.uss_pct||0;

 if(ussRuns>5){
  parts.push('<strong>High-threat framer.</strong> '+name+' generates '+ussRuns.toFixed(1)+' USS runs from '+uss+' uncontested stolen strikes — be challenge-ready on close calls.');
 } else if(ussRuns>2){
  parts.push('<strong>Moderate framing threat.</strong> '+ussRuns.toFixed(1)+' USS runs ('+uss+' uncontested of '+stolenTotal+' total steals).');
 } else if(ussRuns>0){
  parts.push('<strong>Minor threat.</strong> '+ussRuns.toFixed(1)+' USS runs — most stolen strikes are contestable. Save challenges for high-leverage spots.');
 } else {
  parts.push('<strong>Weak framer.</strong> '+ussRuns.toFixed(1)+' USS runs — not a challenge concern.');
 }

 if(stolenTotal>0){
  parts.push((ussPct*100).toFixed(0)+'% of stolen strikes are uncontested (below Tango challenge threshold). '+contested+' of '+stolenTotal+' would be worth challenging under ABS.');
 }

 if(edges&&edges.length){
  const byUss=[...edges].sort((a,b)=>(b.uss_runs||0)-(a.uss_runs||0));
  const bestEdge=byUss[0],worstEdge=byUss[byUss.length-1];
  if((bestEdge.uss_runs||0)>0.5){
   parts.push('<strong>Challenge zone:</strong> '+bestEdge.edge+' edge ('+(bestEdge.uss_runs||0).toFixed(1)+' USS runs, '+(bestEdge.uss||0)+' uncontested). Challenge early-count calls here — high steal probability.');
  }
  if((worstEdge.uss_runs||0)<0.3){
   parts.push('<strong>Let it go:</strong> '+worstEdge.edge+' edge ('+(worstEdge.uss_runs||0).toFixed(1)+' USS runs). Low steal value — save your challenge.');
  }
 }

 if(framing){
  const zones=Object.entries(framing.zones);
  const bestZone=zones.reduce((a,b)=>a[1].rv<b[1].rv?a:b);
  if(bestZone[1].rv<=-3){
   const zoneLabels={top_left:'top-left',top_mid:'top',top_right:'top-right',mid_left:'left',mid_right:'right',bot_left:'bottom-left',bot_mid:'bottom',bot_right:'bottom-right'};
   parts.push('<strong>Key steal zone:</strong> '+zoneLabels[bestZone[0]]+' shadow ('+bestZone[1].rv.toFixed(0)+' Savant run value). This is where the stolen strikes accumulate.');
  }
 }

 return parts.join(' ');
}

function printScoutCards(){
 const team=document.getElementById('sc-team').value;
 if(!team){alert('Select an opponent team first.');return;}
 window.print();
}


/* ═══════════════════════════════════════════════════════════════
   ██  PLAYER DEV — effort distribution & productive vs wasted
   ═══════════════════════════════════════════════════════════════ */

function filtPD(){
 if(!D.catcherMeta) return;
 const team=document.getElementById('pd-team').value;
 let cs=Object.entries(D.catcherMeta);
 if(team!=='ALL') cs=cs.filter(([_,m])=>m.team===team);
 cs.sort((a,b)=>b[1].cs_rate-a[1].cs_rate);

 const sel=document.getElementById('pd-catcher');
 sel.innerHTML='<option value="">Select catcher…</option>'+cs.map(([n,m])=>
  '<option value="'+esc(n)+'">'+shortN(n)+' ('+m.team+') — '+pc(m.cs_rate)+'</option>'
 ).join('');

 document.getElementById('pd-body').innerHTML='';
}

function buildPDReport(){
 const name=document.getElementById('pd-catcher').value;
 const el=document.getElementById('pd-body');
 if(!name){el.innerHTML='';return;}

 const m=D.catcherMeta[name];
 const avg=D.summary.overall_cs_rate;
 const edges=D.catcherPlatoon?D.catcherPlatoon[name]:null;
 const framing=D.catcherFraming?D.catcherFraming[name]:null;
 const pairs=D.pitcherCatcherPairs?D.pitcherCatcherPairs[name]:null;

 const ussRuns=m.uss_runs||0;
 const uss=m.uss||0;
 const contested=m.contested||0;
 const stolenTotal=m.stolen_strikes||0;
 const ussPct=m.uss_pct||0;

 let h='';

 // ── Summary boxes ──
 h+='<div class="pd-summary-row">';
 const rCol=ussRuns>3?'var(--green)':ussRuns<0?'var(--red)':'var(--orange)';
 h+='<div class="pd-summary-box"><div class="pd-sl">USS Runs</div><div class="pd-sv" style="color:'+rCol+'">'+ussRuns.toFixed(1)+'</div><div style="font-family:var(--mono);font-size:11px;color:var(--text3);">RE288-weighted, '+uss+' uncontested steals</div></div>';
 h+='<div class="pd-summary-box"><div class="pd-sl">Stolen Strikes</div><div class="pd-sv">'+stolenTotal+'</div><div style="font-family:var(--mono);font-size:11px;color:var(--text3);">'+uss+' USS / '+contested+' contestable</div></div>';
 h+='<div class="pd-summary-box"><div class="pd-sl">USS Rate</div><div class="pd-sv">'+(ussPct*100).toFixed(0)+'%</div><div style="font-family:var(--mono);font-size:11px;color:var(--text3);">of stolen strikes uncontested</div></div>';

 if(framing){
  const tradCol=framing.rv_tot<=-5?'var(--green)':framing.rv_tot>=5?'var(--red)':'var(--text)';
  h+='<div class="pd-summary-box"><div class="pd-sl">Savant Framing Runs</div><div class="pd-sv" style="color:'+tradCol+'">'+framing.rv_tot.toFixed(1)+'</div><div style="font-family:var(--mono);font-size:11px;color:var(--text3);">Traditional metric</div></div>';
 }
 h+='</div>';

 // ── USS vs Contested bar ──
 if(stolenTotal>0){
  h+='<div class="panel" style="margin-bottom:16px;">';
  h+='<div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Stolen Strike Classification</div>';
  h+='<div class="panel-desc">Each stolen strike classified by the Tango challenge model: USS = confidence below break-even threshold (wouldn\'t be challenged). Contestable = confidence above threshold (worth challenging under ABS). Run values are RE288-weighted per game state.</div>';
  const ussW=Math.max(ussPct*100,3);
  const contW=Math.max((1-ussPct)*100,3);
  h+='<div style="display:flex;gap:2px;height:32px;border-radius:4px;overflow:hidden;margin-bottom:12px;">';
  h+='<div style="width:'+ussW+'%;background:var(--green);display:flex;align-items:center;justify-content:center;"><span style="font-family:var(--mono);font-size:11px;font-weight:700;color:#fff;">'+uss+' USS</span></div>';
  h+='<div style="width:'+contW+'%;background:var(--red);display:flex;align-items:center;justify-content:center;"><span style="font-family:var(--mono);font-size:11px;font-weight:700;color:#fff;">'+contested+' Contestable</span></div>';
  h+='</div>';
  h+='</div>';
 }

 // ── Edge-level USS breakdown using pipeline data ──
 if(edges&&edges.length){
  h+='<div class="panel" style="margin-bottom:16px;">';
  h+='<div class="panel-head"><span class="dot" style="background:var(--blue)"></span> USS by Edge</div>';
  h+='<div class="panel-desc">Per-edge USS runs from the pipeline. USS runs = sum of RE288 deltas for uncontested stolen strikes at each edge.</div>';

  const sorted=[...edges].sort((a,b)=>(b.uss_runs||0)-(a.uss_runs||0));
  let totalUssRuns=0,totalContestedRuns=0;

  h+='<table><thead><tr><th>Edge</th><th>CS Rate</th><th>Stolen</th><th>USS</th><th>Contested</th><th>USS%</th><th>USS Runs</th></tr></thead><tbody>';
  sorted.forEach(e=>{
   const eUss=e.uss||0;
   const eCont=e.contested||0;
   const eTotal=eUss+eCont;
   const eUssPct=eTotal>0?eUss/eTotal:0;
   const eUssRuns=e.uss_runs||0;
   totalUssRuns+=eUssRuns;
   const rvCol=eUssRuns>1?'up':eUssRuns<0?'dn':'';
   h+='<tr><td>'+e.edge+'</td><td>'+pc(e.rate)+'</td><td>'+e.n+'</td><td>'+eUss+'</td><td>'+eCont+'</td><td>'+(eUssPct*100).toFixed(0)+'%</td><td class="'+rvCol+'">'+eUssRuns.toFixed(1)+'</td></tr>';
  });
  h+='</tbody></table>';

  // Visual bars
  h+='<div style="margin-top:12px;">';
  sorted.forEach(e=>{
   const eUssRuns=e.uss_runs||0;
   const eCol=eUssRuns>1?'var(--green)':eUssRuns<0?'var(--red)':'var(--orange)';
   const w=Math.max(e.rate*180,8);
   h+='<div class="pd-bucket">';
   h+='<div class="pd-label">'+e.edge+'</div>';
   h+='<div class="pd-bar"><div class="pd-fill" style="width:'+w+'%;background:'+eCol+'"><span>'+eUssRuns.toFixed(1)+' USS runs · '+(e.uss||0)+'/'+(e.n)+' steals</span></div></div>';
   h+='</div>';
  });
  h+='</div>';

  h+='</div>'; // /panel
 }

 // ── Zone-level framing effort (Savant) ──
 if(framing&&framing.zones){
  h+='<div class="panel" style="margin-bottom:16px;">';
  h+='<div class="panel-head"><span class="dot" style="background:var(--orange)"></span> Zone Framing Efficiency (Savant)</div>';
  h+='<div class="panel-desc">Savant run value by shadow zone region. Negative = runs saved (good).</div>';

  const zoneLabels={top_left:'Top Left',top_mid:'Top Mid',top_right:'Top Right',mid_left:'Mid Left',mid_right:'Mid Right',bot_left:'Bot Left',bot_mid:'Bot Mid',bot_right:'Bot Right'};
  const zones=Object.entries(framing.zones).sort((a,b)=>a[1].rv-b[1].rv);
  h+='<table><thead><tr><th>Zone</th><th>Run Value</th><th>CS%</th></tr></thead><tbody>';
  zones.forEach(([z,zd])=>{
   const rvCol=zd.rv<=-1?'up':zd.rv>=1?'dn':'';
   h+='<tr><td>'+zoneLabels[z]+'</td><td class="'+rvCol+'">'+zd.rv.toFixed(1)+'</td><td>'+pc(zd.pct)+'</td></tr>';
  });
  h+='</tbody></table>';
  h+='</div>';
 }

 // ── Battery Coaching — with USS data per pair ──
 if(pairs&&pairs.length){
  h+='<div class="panel" style="margin-bottom:16px;">';
  h+='<div class="panel-head"><span class="dot" style="background:var(--green)"></span> Battery Optimization</div>';
  h+='<div class="panel-desc">Per-battery USS runs from the pipeline. Shows which pitcher pairings generate the most uncontested stolen strikes.</div>';

  const sorted=[...pairs].sort((a,b)=>(b.uss_runs||0)-(a.uss_runs||0));
  h+='<table><thead><tr><th>Pitcher</th><th>CS Rate</th><th>n</th><th>USS Runs</th><th>USS%</th><th>Recommendation</th></tr></thead><tbody>';
  sorted.forEach(p=>{
   const pUss=p.uss_runs||0;
   const pUssPct=p.uss_pct||0;
   const rvCol=pUss>0.5?'up':pUss<0?'dn':'';
   let rec='';
   if(pUss>2) rec='<span style="color:var(--green);font-weight:600;">High-value battery — pair when possible</span>';
   else if(pUss>0.5) rec='<span style="color:var(--green);">Good USS synergy</span>';
   else if(pUss<-0.5) rec='<span style="color:var(--red);">Negative USS — investigate</span>';
   else rec='<span style="color:var(--text3);">Neutral</span>';

   const hasMeta=D.pitcherMeta&&D.pitcherMeta[p.pitcher];
   const nameCell=hasMeta?'<span class="link-name" onclick="jumpP(\''+esc(p.pitcher)+'\')">'+p.pitcher+'</span>':p.pitcher;
   h+='<tr><td>'+nameCell+'</td><td>'+pc(p.rate)+'</td><td>'+p.n+'</td><td class="'+rvCol+'">'+pUss.toFixed(1)+'</td><td>'+(pUssPct*100).toFixed(0)+'%</td><td style="font-family:var(--sans);font-size:11px;">'+rec+'</td></tr>';
  });
  h+='</tbody></table>';
  h+='</div>';
 }

 // ── Development Note ──
 h+='<div class="panel">';
 h+='<div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Development Summary</div>';
 h+='<div class="note">'+genPDNote(name,m,edges,pairs,avg)+'</div>';
 h+='</div>';

 el.innerHTML=h;
}

function genPDNote(name,m,edges,pairs,avg){
 const parts=[];
 const ussRuns=m.uss_runs||0;
 const uss=m.uss||0;
 const contested=m.contested||0;
 const stolenTotal=m.stolen_strikes||0;
 const ussPct=m.uss_pct||0;

 if(ussRuns>5) parts.push('<strong>'+shortN(name)+' is an elite USS contributor</strong> — '+ussRuns.toFixed(1)+' runs from '+uss+' uncontested stolen strikes.');
 else if(ussRuns>2) parts.push('<strong>'+shortN(name)+' is an above-average framer</strong> at '+ussRuns.toFixed(1)+' USS runs.');
 else if(ussRuns>0) parts.push('<strong>'+shortN(name)+' generates modest USS value</strong> — '+ussRuns.toFixed(1)+' runs.');
 else parts.push('<strong>'+shortN(name)+' is USS-negative</strong> at '+ussRuns.toFixed(1)+' runs.');

 if(stolenTotal>0){
  parts.push(contested+' of '+stolenTotal+' stolen strikes ('+(((1-ussPct)*100).toFixed(0))+'%) are contestable under ABS — those are the steals that disappear with challenges.');
 }

 if(edges&&edges.length){
  const byUss=[...edges].sort((a,b)=>(b.uss_runs||0)-(a.uss_runs||0));
  const best=byUss[0],worst=byUss[byUss.length-1];
  if((best.uss_runs||0)>1){
   parts.push('<strong>Highest-value edge:</strong> '+best.edge+' at '+(best.uss_runs||0).toFixed(1)+' USS runs ('+(best.uss||0)+' uncontested). This is where the real framing value lives.');
  }
  if((worst.uss_runs||0)<0.5&&(worst.contested||0)>(worst.uss||0)){
   parts.push('<strong>Coaching opportunity:</strong> '+worst.edge+' edge — more contestable steals ('+(worst.contested||0)+') than USS ('+(worst.uss||0)+'). Framing effort here gets challenged. Shift to higher-value edges.');
  }
 }

 if(pairs&&pairs.length>1){
  const byUss=[...pairs].sort((a,b)=>(b.uss_runs||0)-(a.uss_runs||0));
  if((byUss[0].uss_runs||0)>1){
   parts.push('<strong>Best battery:</strong> '+byUss[0].pitcher+' at '+(byUss[0].uss_runs||0).toFixed(1)+' USS runs — pair these two when possible.');
  }
 }

 return parts.join(' ');
}


/* ═══════════════════════════════════════════════════════════════
   ██  FRONT OFFICE — side-by-side comparison & leaderboard
   ═══════════════════════════════════════════════════════════════ */

function buildFOLeaderboard(){
 if(!D.catcherMeta){document.getElementById('fo-leaderboard').innerHTML='<div class="note" style="border-left-color:var(--text3)">Catcher data not available.</div>';return;}

 const sortBy=document.getElementById('fo-sort').value;
 const avg=D.summary.overall_cs_rate;

 let catchers=Object.keys(D.catcherMeta).map(name=>{
  const u=getUSS(name);
  const m=D.catcherMeta[name];
  return {name,team:m.team,cs_rate:m.cs_rate,decisions:m.shadow_decisions,
   stolen_strikes:m.stolen_strikes||0,uss_count:m.uss||0,contested:m.contested||0,uss_pct:m.uss_pct||0,...u};
 });

 // Sort
 if(sortBy==='uss_runs') catchers.sort((a,b)=>b.uss_runs-a.uss_runs);
 else if(sortBy==='trad_runs') catchers.sort((a,b)=>a.trad_runs-b.trad_runs);
 else catchers.sort((a,b)=>b.cs_rate-a.cs_rate);

 let h='<div class="panel" style="margin-bottom:16px;">';
 h+='<div class="panel-head"><span class="dot" style="background:var(--accent)"></span> Catcher Valuation Leaderboard</div>';
 h+='<div class="panel-desc">Two parallel valuations: USS Runs = RE288-weighted run value of uncontested stolen strikes (ABS-era projection). Traditional = Savant framing run value (pre-ABS baseline, negative = good). These overlap — USS is a subset of traditional framing filtered for contestability.</div>';
 h+='<table><thead><tr><th></th><th>Rank</th><th>Catcher</th><th>Team</th><th>CS Rate</th><th>Steals</th><th>USS</th><th>USS Runs</th><th>Trad Runs</th></tr></thead><tbody>';

 catchers.forEach((c,i)=>{
  const isSelected=foSelected.has(c.name);
  const ussCol=c.uss_runs>1?'up':c.uss_runs<-1?'dn':'';
  const tradCol=c.trad_runs<=-3?'up':c.trad_runs>=3?'dn':'';
  const csCol=c.cs_rate>avg+0.02?'up':c.cs_rate<avg-0.02?'dn':'';

  h+='<tr class="clickable" style="'+(isSelected?'background:var(--blue-bg);':'')+'">';
  h+='<td><button class="fo-add-btn'+(isSelected?' on':'')+'" onclick="event.stopPropagation();toggleFOSelect(\''+esc(c.name)+'\')" style="padding:2px 8px;font-size:10px;">'+(isSelected?'✓':'+')+' </button></td>';
  h+='<td>'+(i+1)+'</td>';
  h+='<td><span class="link-name" onclick="jumpC(\''+esc(c.name)+'\')">'+c.name+'</span></td>';
  h+='<td>'+c.team+'</td>';
  h+='<td class="'+csCol+'">'+pc(c.cs_rate)+'</td>';
  h+='<td>'+c.stolen_strikes+'</td>';
  h+='<td>'+c.uss_count+'/'+(c.uss_count+c.contested)+'</td>';
  h+='<td class="'+ussCol+'">'+c.uss_runs.toFixed(1)+'</td>';
  h+='<td class="'+tradCol+'">'+(c.trad_runs!==0?c.trad_runs.toFixed(1):'—')+'</td>';
  h+='</tr>';
 });

 h+='</tbody></table></div>';
 document.getElementById('fo-leaderboard').innerHTML=h;

 // Update comparison if catchers selected
 if(foSelected.size>=2) buildFOCompare();
}

function toggleFOSelect(name){
 if(foSelected.has(name)) foSelected.delete(name);
 else foSelected.add(name);
 buildFOLeaderboard();
 if(foSelected.size>=2) buildFOCompare();
 else document.getElementById('fo-compare').classList.add('hidden');
}

function toggleFOCompare(){
 if(foSelected.size<2){
  alert('Select at least 2 catchers from the leaderboard to compare.');
  return;
 }
 buildFOCompare();
}

function clearFOCompare(){
 foSelected.clear();
 document.getElementById('fo-compare').classList.add('hidden');
 buildFOLeaderboard();
}

function buildFOCompare(){
 const el=document.getElementById('fo-compare');
 if(foSelected.size<2){el.classList.add('hidden');return;}
 el.classList.remove('hidden');

 const avg=D.summary.overall_cs_rate;
 const names=[...foSelected];
 const catchers=names.map(name=>{
  const m=D.catcherMeta[name];
  const u=getUSS(name);
  const edges=D.catcherPlatoon?D.catcherPlatoon[name]:null;
  return {name,team:m.team,cs_rate:m.cs_rate,decisions:m.shadow_decisions,
   stolen_strikes:m.stolen_strikes||0,uss_count:m.uss||0,contested:m.contested||0,uss_pct:m.uss_pct||0,edges,...u};
 });

 // Find the best/reference (first selected)
 const ref=catchers[0];

 let h='<div class="panel" style="margin-top:16px;">';
 h+='<div class="panel-head"><span class="dot" style="background:var(--blue)"></span> Side-by-Side Comparison</div>';
 h+='<div class="panel-desc">Comparing '+catchers.length+' catchers. Differences shown relative to '+ref.name+'.</div>';

 // Comparison cards
 const cols=Math.min(catchers.length,4);
 h+='<div class="fo-compare-grid" style="grid-template-columns:repeat('+cols+',1fr);">';
 catchers.forEach((c,i)=>{
  const isRef=i===0;
  h+='<div class="fo-compare-card" style="'+(isRef?'border-color:var(--blue);border-width:2px;':'')+'">';
  h+='<div class="fo-name">'+c.name+(isRef?' <span style="font-family:var(--mono);font-size:9px;color:var(--blue);font-weight:600;vertical-align:middle;">BASELINE</span>':'')+'</div>';
  h+='<div class="fo-team">'+c.team+' · '+c.decisions+' decisions</div>';

  // Metrics
  const metrics=[
   {label:'Shadow CS Rate',val:pc(c.cs_rate),raw:c.cs_rate,refRaw:ref.cs_rate,fmt:'pct',good:'higher'},
   {label:'USS Runs',val:c.uss_runs.toFixed(1),raw:c.uss_runs,refRaw:ref.uss_runs,fmt:'num',good:'higher'},
   {label:'USS / Stolen',val:c.uss_count+'/'+(c.uss_count+c.contested),raw:c.uss_count,refRaw:ref.uss_count,fmt:'num',good:'higher'},
   {label:'USS Rate',val:(c.uss_pct*100).toFixed(0)+'%',raw:c.uss_pct,refRaw:ref.uss_pct,fmt:'pct',good:'higher'},
   {label:'Trad Framing Runs',val:c.trad_runs!==0?c.trad_runs.toFixed(1):'—',raw:c.trad_runs,refRaw:ref.trad_runs,fmt:'num',good:'lower'}
  ];

  metrics.forEach(met=>{
   h+='<div class="fo-metric">';
   h+='<div class="fo-ml">'+met.label+'</div>';
   h+='<div><span class="fo-mv">'+met.val+'</span>';
   if(!isRef&&met.val!=='—'){
    let diff;
    if(met.fmt==='pct') diff=((met.raw-met.refRaw)*100).toFixed(1);
    else diff=(met.raw-met.refRaw).toFixed(1);
    const isGood=(met.good==='higher'&&parseFloat(diff)>0)||(met.good==='lower'&&parseFloat(diff)<0);
    const isBad=(met.good==='higher'&&parseFloat(diff)<0)||(met.good==='lower'&&parseFloat(diff)>0);
    const cls=isGood?'pos':isBad?'neg':'neu';
    const sign=parseFloat(diff)>0?'+':'';
    h+='<span class="fo-delta '+cls+'">'+sign+diff+(met.fmt==='pct'?'pp':'')+'</span>';
   }
   h+='</div></div>';
  });

  // Edge profile mini-view
  if(c.edges&&c.edges.length){
   h+='<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);">';
   h+='<div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Edge Profile</div>';
   const sorted=[...c.edges].sort((a,b)=>b.rate-a.rate);
   sorted.forEach(e=>{
    const eCol=e.rate>avg+0.05?'var(--green)':e.rate<avg-0.05?'var(--red)':'var(--text3)';
    const w=Math.max(e.rate*180,8);
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:2px;">';
    h+='<div style="width:50px;text-align:right;font-family:var(--mono);font-size:10px;color:var(--text3);">'+e.edge+'</div>';
    h+='<div style="flex:1;height:14px;background:var(--bg2);border-radius:2px;overflow:hidden;"><div style="width:'+w+'%;height:100%;background:'+eCol+';border-radius:2px;"></div></div>';
    h+='<div style="width:38px;text-align:right;font-family:var(--mono);font-size:10px;color:var(--text2);">'+pc(e.rate)+'</div>';
    h+='</div>';
   });
   h+='</div>';
  }

  h+='</div>'; // /fo-compare-card
 });
 h+='</div>'; // /fo-compare-grid

 // Trade/FA value summary
 h+='<div class="note" style="margin-top:16px;">';
 if(catchers.length===2){
  const a=catchers[0],b=catchers[1];
  const ussGap=(b.uss_runs-a.uss_runs).toFixed(1);
  const tradGap=((-1*b.trad_runs)-(-1*a.trad_runs)).toFixed(1);
  h+='<strong>Acquisition Value:</strong> Replacing '+a.name+' with '+b.name+' projects to a ';
  if(parseFloat(ussGap)>0) h+='<strong style="color:var(--green);">+'+ussGap+' USS run upgrade</strong>';
  else if(parseFloat(ussGap)<0) h+='<strong style="color:var(--red);">'+ussGap+' USS run downgrade</strong>';
  else h+='<strong>neutral USS impact</strong>';
  if(b.trad_runs!==0&&a.trad_runs!==0){
   h+='. Traditional framing metrics show a ';
   if(parseFloat(tradGap)>0) h+='+'+tradGap+' run difference';
   else if(parseFloat(tradGap)<0) h+=tradGap+' run difference';
   else h+='neutral difference';
   h+='.';
  } else h+='.';
 } else {
  const best=catchers.reduce((a,b)=>a.uss_runs>b.uss_runs?a:b);
  const worst=catchers.reduce((a,b)=>a.uss_runs<b.uss_runs?a:b);
  const gap=(best.uss_runs-worst.uss_runs).toFixed(1);
  h+='<strong>Range:</strong> '+gap+' USS run spread across compared catchers. '+best.name+' leads at '+best.uss_runs.toFixed(1)+' USS runs; '+worst.name+' trails at '+worst.uss_runs.toFixed(1)+'.';
 }
 h+='</div>';

 h+='</div>'; // /panel
 el.innerHTML=h;
}
</script>
</body>
</html>
